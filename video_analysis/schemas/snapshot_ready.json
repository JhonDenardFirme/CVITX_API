{
  "$comment": "File: /home/ubuntu/cvitx/video_analysis/schemas/snapshot_ready.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://cvitx.dev/schemas/snapshot_ready.json",
  "title": "SNAPSHOT_READY (Outbound from YOLO Worker)",
  "description": "Schema for snapshot notifications emitted by the YOLO Video Worker.",
  "$defs": {
    "uuid": {
      "type": "string",
      "format": "uuid",
      "pattern": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$"
    },
    "iso_datetime_nullable": {
      "oneOf": [
        { "type": "string", "format": "date-time" },
        { "type": "null" }
      ],
      "description": "RFC 3339 / ISO-8601 timestamp or null"
    }
  },
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "event": { "type": "string", "const": "SNAPSHOT_READY" },
    "video_id": { "$ref": "#/$defs/uuid" },
    "workspace_id": { "$ref": "#/$defs/uuid" },
    "workspace_code": {
      "type": "string",
      "pattern": "^CTX\\d{4,}$",
      "description": "Deterministic workspace code (e.g., CTX1026)."
    },
    "camera_code": {
      "type": "string",
      "minLength": 1,
      "description": "Deterministic camera code (e.g., CAM-TEST-004)."
    },
    "track_id": {
      "type": "integer",
      "minimum": 1,
      "description": "1-based tracking ID for the vehicle trajectory."
    },
    "snapshot_s3_key": {
      "type": "string",
      "description": "Full s3:// URI to the snapshot image.",
      "pattern": "^s3://[^/]+/demo_user/[0-9a-fA-F-]{36}/[0-9a-fA-F-]{36}/snapshots/CTX\\d{4,}_[A-Za-z0-9-]+_\\d{6}_\\d{6}\\.jpg$"
    },
    "recordedAt": { "$ref": "#/$defs/iso_datetime_nullable" },
    "detectedIn": {
      "type": "integer",
      "minimum": 0,
      "description": "Detection offset in milliseconds from stream start."
    },
    "detectedAt": { "$ref": "#/$defs/iso_datetime_nullable" },
    "yolo_type": {
      "type": "string",
      "description": "Coarse vehicle type predicted by YOLO (e.g., Car, SUV, Bus)."
    },
    "variant": {
      "type": "string",
      "description": "Model variant associated with this run (e.g., 'baseline' or 'cmt')."
    },
    "run_id": {
      "$ref": "#/$defs/uuid"
    }
  },
  "required": [
    "event",
    "video_id",
    "workspace_id",
    "workspace_code",
    "camera_code",
    "track_id",
    "snapshot_s3_key",
    "recordedAt",
    "detectedIn",
    "detectedAt",
    "yolo_type",
    "variant",
    "run_id"
  ],
  "examples": [
    {
      "event": "SNAPSHOT_READY",
      "video_id": "7992c53b-1111-2222-3333-444455556666",
      "workspace_id": "8cdc46f9-12eb-4e07-ac44-f84dd1fdfb96",
      "workspace_code": "CTX1026",
      "camera_code": "CAM-TEST-004",
      "track_id": 12,
      "snapshot_s3_key": "s3://cvitx-uploads-dev-jdfirme/demo_user/8cdc46f9-12eb-4e07-ac44-f84dd1fdfb96/7992c53b-1111-2222-3333-444455556666/snapshots/CTX1026_CAM-TEST-004_000012_003000.jpg",
      "recordedAt": "2025-10-31T12:15:00+08:00",
      "detectedIn": 3000,
      "detectedAt": "2025-10-31T12:15:03+08:00",
      "yolo_type": "Car",
      "variant": "cmt",
      "run_id": "d8f6a2aa-aaaa-bbbb-cccc-ddddeeeeffff"
    }
  ]
}

