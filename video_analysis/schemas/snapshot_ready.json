{
  "$comment": "File: /home/ubuntu/cvitx/video_analysis/schemas/snapshot_ready.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://cvitx.dev/schemas/snapshot_ready.json",
  "title": "SNAPSHOT_READY (Outbound from YOLO → Inbound to Main-Model)",
  "description": "Deterministic schema for snapshot notifications. The JPEG must already exist at the given S3 URI. Names are fixed: CTX####_CAM#_{track:06d}_{offsetMs:06d}.jpg",
  "$defs": {
    "uuid": {
      "type": "string",
      "format": "uuid",
      "pattern": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$"
    },
    "iso_datetime_nullable": {
      "oneOf": [
        { "type": "string", "format": "date-time" },
        { "type": "null" }
      ],
      "description": "RFC 3339 / ISO-8601 timestamp or null"
    },
    "yolo_type": {
      "type": "string",
      "enum": [
        "Car",
        "SUV",
        "Van",
        "LightTruck",
        "Utility",
        "Motorcycle",
        "CarouselBus",
        "E-Jeepney"
      ]
    }
  },

  "type": "object",
  "additionalProperties": false,

  "properties": {
    "event": { "type": "string", "const": "SNAPSHOT_READY" },

    "video_id": { "$ref": "#/$defs/uuid" },
    "workspace_id": { "$ref": "#/$defs/uuid" },

    "workspace_code": {
      "type": "string",
      "pattern": "^CTX\\d{4,}$",
      "description": "Deterministic workspace code (e.g., CTX1005)"
    },
    "camera_code": {
      "type": "string",
      "pattern": "^CAM\\d+$",
      "description": "Deterministic camera code (e.g., CAM1)"
    },

    "track_id": {
      "type": "integer",
      "minimum": 1,
      "description": "Monotonic ID within this video session (rendered as 6 digits in filename)"
    },

    "snapshot_s3_key": {
      "type": "string",
      "pattern": "^s3://cvitx-uploads-dev-jdfirme/demo_user/[0-9a-fA-F-]{36}/[0-9a-fA-F-]{36}/snapshots/CTX\\d{4,}_CAM\\d+_\\d{6}_\\d{6}\\.jpg$",
      "description": "FULL S3 URI to the 640×640 JPEG snapshot (bucket fixed to cvitx-uploads-dev-jdfirme)."
    },

    "recordedAt": { "$ref": "#/$defs/iso_datetime_nullable" },
    "detectedIn": {
      "type": "integer",
      "minimum": 0,
      "description": "Offset in milliseconds from the start of the video"
    },
    "detectedAt": { "$ref": "#/$defs/iso_datetime_nullable" },

    "yolo_type": { "$ref": "#/$defs/yolo_type" }
  },

  "required": [
    "event",
    "video_id",
    "workspace_id",
    "workspace_code",
    "camera_code",
    "track_id",
    "snapshot_s3_key",
    "recordedAt",
    "detectedIn",
    "detectedAt",
    "yolo_type"
  ],

  "examples": [
    {
      "event": "SNAPSHOT_READY",
      "video_id": "c03b34d8-9a6a-4701-998a-de9001fe2fa4",
      "workspace_id": "8cdc46f9-12eb-4e07-ac44-f84dd1fdfb96",
      "workspace_code": "CTX1005",
      "camera_code": "CAM1",
      "track_id": 305,
      "snapshot_s3_key": "s3://cvitx-uploads-dev-jdfirme/demo_user/8cdc46f9-12eb-4e07-ac44-f84dd1fdfb96/c03b34d8-9a6a-4701-998a-de9001fe2fa4/snapshots/CTX1005_CAM1_000305_002272.jpg",
      "recordedAt": null,
      "detectedIn": 2272,
      "detectedAt": null,
      "yolo_type": "SUV"
    }
  ],

  "$comment_aws": "================================================================================\nNO AWS SETUP REQUIRED FOR THIS FILE (Schema only; used by validators).\n================================================================================"
}
