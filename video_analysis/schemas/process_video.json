{
  "$comment": "File: /home/ubuntu/cvitx/video_analysis/schemas/process_video.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://cvitx.dev/schemas/process_video.json",
  "title": "PROCESS_VIDEO (Primary Inbound â€” Full Payload)",
  "description": "Authoritative schema for PROCESS_VIDEO messages sent to the YOLO Video Worker. Enforces deterministic keys, IDs, and field formats.",
  "$defs": {
    "uuid": {
      "type": "string",
      "format": "uuid",
      "pattern": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$"
    },
    "iso_datetime_nullable": {
      "oneOf": [
        { "type": "string", "format": "date-time" },
        { "type": "null" }
      ],
      "description": "RFC 3339 / ISO-8601 timestamp or null"
    }
  },
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "event": { "type": "string", "const": "PROCESS_VIDEO" },
    "video_id": { "$ref": "#/$defs/uuid" },
    "workspace_id": { "$ref": "#/$defs/uuid" },
    "workspace_code": {
      "oneOf": [
        {
          "type": "string",
          "pattern": "^CTX\\d{4,}$",
          "description": "Deterministic workspace code (e.g., CTX1005)"
        },
        {
          "type": "null",
          "description": "Nullable for legacy rows without workspace_code"
        }
      ]
    },
    "camera_code": {
      "type": "string",
      "minLength": 1,
      "description": "Deterministic camera code (e.g., CAM-TEST-004)"
    },
    "s3_key_raw": {
      "type": "string",
      "pattern": "^demo_user/[0-9a-fA-F-]{36}/[0-9a-fA-F-]{36}/raw/.+\\.mp4$",
      "description": "S3 KEY (not URI) to the raw MP4. Bucket is fixed by deployment config."
    },
    "frame_stride": {
      "type": "integer",
      "minimum": 1,
      "description": "Decode every Nth frame (>=1). If missing upstream, API must supply a default."
    },
    "recordedAt": { "$ref": "#/$defs/iso_datetime_nullable" },
    "variant": {
      "type": "string",
      "description": "Model variant (e.g., 'baseline' or 'cmt'). Defaults to 'cmt'."
    },
    "run_id": {
      "oneOf": [
        { "$ref": "#/$defs/uuid" },
        { "type": "null" }
      ],
      "description": "Optional logical run identifier, assigned by the worker if omitted."
    }
  },
  "required": [
    "event",
    "video_id",
    "workspace_id",
    "camera_code",
    "s3_key_raw",
    "frame_stride",
    "recordedAt"
  ],
  "examples": [
    {
      "event": "PROCESS_VIDEO",
      "video_id": "7992c53b-1111-2222-3333-444455556666",
      "workspace_id": "8cdc46f9-12eb-4e07-ac44-f84dd1fdfb96",
      "workspace_code": "CTX1026",
      "camera_code": "CAM-TEST-004",
      "s3_key_raw": "demo_user/8cdc46f9-12eb-4e07-ac44-f84dd1fdfb96/7992c53b-1111-2222-3333-444455556666/raw/test-4.mp4",
      "frame_stride": 3,
      "recordedAt": "2025-10-31T12:15:00+08:00",
      "variant": "cmt",
      "run_id": null
    }
  ],
  "$comment_aws": "================================================================================\nNO AWS SETUP REQUIRED FOR THIS FILE (Schema only; used by validators).\n================================================================================"
}

